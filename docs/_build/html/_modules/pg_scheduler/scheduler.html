<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">
        <link rel="prefetch" href="../../_static/logo-light.png" as="image">
        <link rel="prefetch" href="../../_static/logo-dark.png" as="image">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>pg_scheduler.scheduler - PG Scheduler 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=acfd86a5" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">PG Scheduler 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/logo-light.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/logo-dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PG Scheduler 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user-guide/index.html">User Guide</a><input aria-label="Toggle navigation of User Guide" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/index.html">Examples</a><input aria-label="Toggle navigation of Examples" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment.html">Production Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pg_scheduler.scheduler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">asyncpg</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="JobPriority">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.JobPriority">[docs]</a>
<span class="k">class</span> <span class="nc">JobPriority</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c1"># TODO: Implement enums at DB level</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;User-friendly job priority levels&quot;&quot;&quot;</span>
    <span class="n">NORMAL</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>      <span class="c1"># Default priority (value: 5)</span>
    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>  <span class="c1"># High priority (value: 1) - lower numbers = higher priority</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert enum to database integer value (lower = higher priority)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    
<div class="viewcode-block" id="JobPriority.from_db_value">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.JobPriority.from_db_value">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_db_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;JobPriority&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert database integer back to enum&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">db_value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="ConflictResolution">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.ConflictResolution">[docs]</a>
<span class="k">class</span> <span class="nc">ConflictResolution</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategies for handling duplicate job_id conflicts&quot;&quot;&quot;</span>
    <span class="n">RAISE</span> <span class="o">=</span> <span class="s2">&quot;raise&quot;</span>        <span class="c1"># Raise ValueError (default, safest)</span>
    <span class="n">IGNORE</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span>      <span class="c1"># Ignore the new job, return existing job_id  </span>
    <span class="n">REPLACE</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span>    <span class="c1"># Replace/update the existing job with new parameters</span></div>


<div class="viewcode-block" id="VacuumTrigger">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumTrigger">[docs]</a>
<span class="k">class</span> <span class="nc">VacuumTrigger</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Vacuum policy trigger types&quot;&quot;&quot;</span>
    <span class="n">IMMEDIATE</span> <span class="o">=</span> <span class="s2">&quot;immediate&quot;</span>      <span class="c1"># Delete immediately on status change</span>
    <span class="n">TIME_BASED</span> <span class="o">=</span> <span class="s2">&quot;time_based&quot;</span>    <span class="c1"># Delete after X time</span>
    <span class="n">COUNT_BASED</span> <span class="o">=</span> <span class="s2">&quot;count_based&quot;</span>  <span class="c1"># Keep only last N jobs</span>
    <span class="n">NEVER</span> <span class="o">=</span> <span class="s2">&quot;never&quot;</span>              <span class="c1"># No automatic cleanup</span></div>


<div class="viewcode-block" id="VacuumPolicy">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumPolicy">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VacuumPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for a vacuum policy&quot;&quot;&quot;</span>
    <span class="n">trigger</span><span class="p">:</span> <span class="n">VacuumTrigger</span>
    <span class="n">days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>           <span class="c1"># For TIME_BASED policies</span>
    <span class="n">keep_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># For COUNT_BASED policies</span>
    
<div class="viewcode-block" id="VacuumPolicy.immediate">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumPolicy.immediate">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">immediate</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;VacuumPolicy&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete immediately when job reaches this status&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">IMMEDIATE</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="VacuumPolicy.after_days">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumPolicy.after_days">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">after_days</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;VacuumPolicy&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete jobs after N days in this status&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">TIME_BASED</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="VacuumPolicy.keep_last">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumPolicy.keep_last">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">keep_last</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;VacuumPolicy&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep only the last N jobs per job_name in this status&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">COUNT_BASED</span><span class="p">,</span> <span class="n">keep_count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="VacuumPolicy.never">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumPolicy.never">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">never</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;VacuumPolicy&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Never automatically clean jobs in this status&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">NEVER</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="VacuumConfig">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VacuumConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete vacuum configuration for the scheduler&quot;&quot;&quot;</span>
    <span class="n">completed</span><span class="p">:</span> <span class="n">VacuumPolicy</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># Will default to after_days(1)</span>
    <span class="n">failed</span><span class="p">:</span> <span class="n">VacuumPolicy</span> <span class="o">=</span> <span class="kc">None</span>          <span class="c1"># Will default to after_days(7)  </span>
    <span class="n">cancelled</span><span class="p">:</span> <span class="n">VacuumPolicy</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># Will default to after_days(3)</span>
    <span class="n">interval_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>           <span class="c1"># How often to run vacuum</span>
    <span class="n">track_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># Whether to store vacuum metrics in DB</span>
    
<div class="viewcode-block" id="VacuumConfig.__post_init__">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.VacuumConfig.__post_init__">[docs]</a>
    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set sensible defaults for None policies&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="n">VacuumPolicy</span><span class="o">.</span><span class="n">after_days</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="n">VacuumPolicy</span><span class="o">.</span><span class="n">after_days</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cancelled</span> <span class="o">=</span> <span class="n">VacuumPolicy</span><span class="o">.</span><span class="n">after_days</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>
</div>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PeriodicJobConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for a periodic job&quot;&quot;&quot;</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">interval</span><span class="p">:</span> <span class="n">timedelta</span>
    <span class="n">use_advisory_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">priority</span><span class="p">:</span> <span class="s1">&#39;JobPriority&#39;</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will default to JobPriority.NORMAL</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Auto-generated from function name if None</span>
    <span class="n">dedup_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Auto-generated if None</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set defaults and generate dedup key&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Import here to avoid circular import</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">JobPriority</span><span class="o">.</span><span class="n">NORMAL</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;periodic_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Generate deterministic dedup key based on function and interval</span>
            <span class="n">func_signature</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">interval_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">key_material</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_signature</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">interval_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dedup_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">key_material</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">PeriodicJobRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry for periodic jobs&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_jobs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PeriodicJobConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PeriodicJobConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a periodic job&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_jobs</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">dedup_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered periodic job: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> (every </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2">, dedup_key=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">dedup_key</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">:</span> <span class="s1">&#39;Scheduler&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the scheduler instance&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>
    
    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PeriodicJobConfig</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all registered periodic jobs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_jobs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">start_all_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start all enabled periodic jobs&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No scheduler set on periodic job registry&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_periodic_job</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_start_periodic_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PeriodicJobConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a single periodic job&quot;&quot;&quot;</span>
        <span class="c1"># Calculate next execution time</span>
        <span class="n">next_run</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">interval</span>
        
        <span class="c1"># Create dedup job ID for this window</span>
        <span class="n">window_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_window_key</span><span class="p">(</span><span class="n">next_run</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;periodic:</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">dedup_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">window_key</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_periodic_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
                <span class="n">execution_time</span><span class="o">=</span><span class="n">next_run</span><span class="p">,</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
                <span class="n">conflict_resolution</span><span class="o">=</span><span class="n">ConflictResolution</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">,</span>  <span class="c1"># Dedup across replicas</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduled periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">next_run</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to schedule periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_window_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a window key for deduplication within time windows&quot;&quot;&quot;</span>
        <span class="c1"># Round down to the nearest interval boundary</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">UTC</span><span class="p">)</span>
        <span class="n">seconds_since_epoch</span> <span class="o">=</span> <span class="p">(</span><span class="n">execution_time</span> <span class="o">-</span> <span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">interval_seconds</span> <span class="o">=</span> <span class="n">interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">window_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds_since_epoch</span> <span class="o">//</span> <span class="n">interval_seconds</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">window_number</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_create_periodic_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PeriodicJobConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a wrapper function that handles periodic job execution and rescheduling&quot;&quot;&quot;</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">periodic_wrapper</span><span class="p">():</span>
            <span class="n">lock_acquired</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">lock_key</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If advisory lock is enabled, try to acquire lock</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_advisory_lock</span><span class="p">:</span>
                    <span class="n">lock_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_advisory_lock_key</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                    <span class="n">lock_acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_acquire_advisory_lock</span><span class="p">(</span><span class="n">lock_key</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">lock_acquired</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Advisory lock for </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> already held by another worker, skipping execution&quot;</span><span class="p">)</span>
                        <span class="k">return</span>  <span class="c1"># Skip execution if lock can&#39;t be acquired</span>
                
                <span class="c1"># Execute the original function</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Handle sync functions</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="p">()</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> completed successfully&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>  <span class="c1"># Re-raise to let scheduler handle retries</span>
            
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Release advisory lock if it was acquired</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_advisory_lock</span> <span class="ow">and</span> <span class="n">lock_acquired</span> <span class="ow">and</span> <span class="n">lock_key</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_advisory_lock</span><span class="p">(</span><span class="n">lock_key</span><span class="p">)</span>
                
                <span class="c1"># Always reschedule for next execution (self-rescheduling)</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reschedule_periodic_job</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        
        <span class="c1"># Set function name for scheduler registration</span>
        <span class="n">periodic_wrapper</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;periodic_</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">periodic_wrapper</span>
    
    <span class="k">def</span> <span class="nf">_get_advisory_lock_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PeriodicJobConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a numeric lock key for PostgreSQL advisory locks&quot;&quot;&quot;</span>
        <span class="c1"># PostgreSQL advisory locks use bigint (int8), so we need a numeric key</span>
        <span class="c1"># Hash the dedup_key to get a consistent numeric value</span>
        <span class="n">hash_bytes</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dedup_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;q&#39;</span><span class="p">,</span> <span class="n">hash_bytes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Convert to signed 64-bit int</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_try_acquire_advisory_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to acquire a PostgreSQL advisory lock (non-blocking)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">db_pool</span><span class="o">.</span><span class="n">fetchval</span><span class="p">(</span>
                <span class="s2">&quot;SELECT pg_try_advisory_lock($1);&quot;</span><span class="p">,</span> <span class="n">lock_key</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to acquire advisory lock </span><span class="si">{</span><span class="n">lock_key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_release_advisory_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lock_key</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Release a PostgreSQL advisory lock&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">db_pool</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;SELECT pg_advisory_unlock($1);&quot;</span><span class="p">,</span> <span class="n">lock_key</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to release advisory lock </span><span class="si">{</span><span class="n">lock_key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_reschedule_periodic_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PeriodicJobConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reschedule the periodic job for the next execution&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_run</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">interval</span>
            <span class="n">window_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_window_key</span><span class="p">(</span><span class="n">next_run</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;periodic:</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">dedup_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">window_key</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_periodic_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
                <span class="n">execution_time</span><span class="o">=</span><span class="n">next_run</span><span class="p">,</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
                <span class="n">conflict_resolution</span><span class="o">=</span><span class="n">ConflictResolution</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rescheduled periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">next_run</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to reschedule periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Global registry instance</span>
<span class="n">_periodic_registry</span> <span class="o">=</span> <span class="n">PeriodicJobRegistry</span><span class="p">()</span>

<div class="viewcode-block" id="periodic">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.periodic">[docs]</a>
<span class="k">def</span> <span class="nf">periodic</span><span class="p">(</span><span class="n">every</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span> 
            <span class="n">use_advisory_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">priority</span><span class="p">:</span> <span class="n">JobPriority</span> <span class="o">=</span> <span class="n">JobPriority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dedup_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator to mark an async function as a periodic job.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Guarantees exactly one enqueue per window across many replicas (via dedup key)</span>
<span class="sd">    - Self-reschedules at the end of each run</span>
<span class="sd">    - Optional advisory-lock protection (alternative to dedup)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        every: Time interval between executions (timedelta)</span>
<span class="sd">        use_advisory_lock: Use PostgreSQL advisory locks instead of dedup (future feature)</span>
<span class="sd">        priority: Job priority (JobPriority.NORMAL or JobPriority.CRITICAL)</span>
<span class="sd">        max_retries: Maximum retry attempts for failed executions</span>
<span class="sd">        job_name: Custom job name (auto-generated from function name if None)</span>
<span class="sd">        dedup_key: Custom deduplication key (auto-generated if None)</span>
<span class="sd">        enabled: Whether the periodic job is enabled</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        @periodic(every=timedelta(minutes=15))</span>
<span class="sd">        async def cleanup_temp_files():</span>
<span class="sd">            # Your periodic task code here</span>
<span class="sd">            pass</span>
<span class="sd">            </span>
<span class="sd">        @periodic(every=timedelta(hours=1), priority=JobPriority.CRITICAL, max_retries=3)</span>
<span class="sd">        async def generate_daily_report():</span>
<span class="sd">            # Critical periodic task with retries</span>
<span class="sd">            pass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="c1"># Validate function is async</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@periodic can only be applied to async functions, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create periodic job configuration</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">PeriodicJobConfig</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">every</span><span class="p">,</span>
            <span class="n">use_advisory_lock</span><span class="o">=</span><span class="n">use_advisory_lock</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
            <span class="n">dedup_key</span><span class="o">=</span><span class="n">dedup_key</span><span class="p">,</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">enabled</span>
        <span class="p">)</span>
        
        <span class="c1"># Register with global registry</span>
        <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        
        <span class="c1"># Return the original function (it&#39;s still callable directly)</span>
        <span class="k">return</span> <span class="n">func</span>
    
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="Scheduler">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler">[docs]</a>
<span class="k">class</span> <span class="nc">Scheduler</span><span class="p">:</span>
    <span class="n">HEARTBEAT_THRESHOLD</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># 2 minutes (in seconds)</span>
    <span class="n">LEASE_DURATION</span> <span class="o">=</span> <span class="mi">60</span>        <span class="c1"># 1 minute lease duration (in seconds)</span>
    <span class="n">WORKER_ID_LENGTH</span> <span class="o">=</span> <span class="mi">8</span>       <span class="c1"># For worker identification</span>

<div class="viewcode-block" id="Scheduler.__init__">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">db_pool</span><span class="p">:</span> <span class="n">asyncpg</span><span class="o">.</span><span class="n">Pool</span><span class="p">,</span> 
                 <span class="n">max_concurrent_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> 
                 <span class="n">misfire_grace_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 minutes default</span>
                 <span class="n">vacuum_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VacuumConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">vacuum_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Scheduler with concurrency control and reliability features.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            db_pool: Connection to the PostgreSQL database.</span>
<span class="sd">            max_concurrent_jobs: Maximum number of jobs to run concurrently</span>
<span class="sd">            misfire_grace_time: Seconds after execution_time before jobs expire (like APScheduler)</span>
<span class="sd">            vacuum_config: Configuration for job cleanup policies (uses defaults if None)</span>
<span class="sd">            vacuum_enabled: Whether to enable automatic vacuum cleanup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_pool</span> <span class="o">=</span> <span class="n">db_pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Store task functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Generate unique worker ID for this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="bp">self</span><span class="o">.</span><span class="n">WORKER_ID_LENGTH</span><span class="p">]</span>
        
        <span class="c1"># Concurrency control with tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_jobs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Track active job IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Track active asyncio tasks</span>
        
        <span class="c1"># Job expiration policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misfire_grace_time</span> <span class="o">=</span> <span class="n">misfire_grace_time</span>
        
        <span class="c1"># Vacuum configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_enabled</span> <span class="o">=</span> <span class="n">vacuum_enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span> <span class="o">=</span> <span class="n">vacuum_config</span> <span class="ow">or</span> <span class="n">VacuumConfig</span><span class="p">()</span>
        
        <span class="c1"># Background tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_monitor_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orphan_recovery_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_task</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Periodic jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic_jobs_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">set_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Setup signal handlers for graceful shutdown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_signal_handlers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_task</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduler initialized: worker_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;max_concurrent=</span><span class="si">{</span><span class="n">max_concurrent_jobs</span><span class="si">}</span><span class="s2">, misfire_grace=</span><span class="si">{</span><span class="n">misfire_grace_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_setup_signal_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup signal handlers for graceful shutdown&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">):</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_signal_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle shutdown signals gracefully&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received signal </span><span class="si">{</span><span class="n">signum</span><span class="si">}</span><span class="s2">, initiating graceful shutdown...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>

<div class="viewcode-block" id="Scheduler.start">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the scheduler with reliability features&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Initialize database with worker tracking</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_db</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_task_functions</span><span class="p">()</span>
            
            <span class="c1"># RELIABILITY: Recover orphaned jobs from previous crashes</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recover_orphaned_jobs</span><span class="p">()</span>
            
            <span class="c1"># Start background tasks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_monitor_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_heartbeats</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orphan_recovery_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodic_orphan_recovery</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listener_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listen_for_jobs</span><span class="p">())</span>
            
            <span class="c1"># Start vacuum task if enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vacuum_loop</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduler started: worker_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">, vacuum_enabled=True&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduler started: worker_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">, vacuum_enabled=False&quot;</span><span class="p">)</span>
            
            <span class="c1"># Start periodic jobs if enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic_jobs_enabled</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">start_all_jobs</span><span class="p">()</span>
                <span class="n">periodic_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_periodic_registry</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started </span><span class="si">{</span><span class="n">periodic_count</span><span class="si">}</span><span class="s2"> periodic jobs&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting scheduler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_background_tasks</span><span class="p">()</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="Scheduler.shutdown">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.shutdown">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shutdown the scheduler gracefully with job completion&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gracefully stopping scheduler </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Wait for active jobs to complete (with timeout)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> active jobs to complete...&quot;</span><span class="p">)</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 30 second timeout</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span> <span class="ow">and</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timed out waiting for jobs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="si">}</span><span class="s2"> to complete&quot;</span><span class="p">)</span>
        
        <span class="c1"># Wait for any remaining active tasks to complete or cancel them</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span><span class="p">)</span><span class="si">}</span><span class="s2"> active tasks to complete...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
            
            <span class="c1"># Cancel any tasks that didn&#39;t complete</span>
            <span class="n">remaining_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">remaining_tasks</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remaining_tasks</span><span class="p">)</span><span class="si">}</span><span class="s2"> remaining tasks&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">remaining_tasks</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="c1"># Wait for cancellation to complete</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">remaining_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Clean up background tasks</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_background_tasks</span><span class="p">()</span>
        
        <span class="c1"># Mark any remaining jobs as failed (they&#39;ll be retried by other workers)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mark_remaining_jobs_failed</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduler </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2"> stopped gracefully&quot;</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_cleanup_background_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up all background tasks&quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_monitor_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orphan_recovery_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_task</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        
        <span class="c1"># Wait for tasks to complete</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">t</span><span class="p">],</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_mark_remaining_jobs_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark any jobs still tracked as active as failed for retry by other workers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE scheduled_jobs </span>
<span class="s2">                SET status = &#39;pending&#39;, </span>
<span class="s2">                    last_heartbeat = NULL,</span>
<span class="s2">                    lease_until = NULL,</span>
<span class="s2">                    worker_id = NULL</span>
<span class="s2">                WHERE job_id = ANY($1) AND status = &#39;running&#39;;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">))</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marked </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs for retry by other workers&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to mark remaining jobs as failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.initialize_db">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.initialize_db">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">initialize_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize database with worker tracking and reliability features&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS scheduled_jobs (</span>
<span class="s2">                job_id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,</span>
<span class="s2">                job_name TEXT NOT NULL,</span>
<span class="s2">                execution_time TIMESTAMPTZ NOT NULL,</span>
<span class="s2">                status TEXT DEFAULT &#39;pending&#39;,</span>
<span class="s2">                task_data JSONB,</span>
<span class="s2">                created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">                last_heartbeat TIMESTAMPTZ,</span>
<span class="s2">                lease_until TIMESTAMPTZ,  -- Explicit lease expiration</span>
<span class="s2">                priority INTEGER DEFAULT 5,</span>
<span class="s2">                retry_count INTEGER DEFAULT 0,</span>
<span class="s2">                max_retries INTEGER DEFAULT 0,</span>
<span class="s2">                worker_id TEXT,  -- Track which worker is processing</span>
<span class="s2">                error_message TEXT -- Track last error for debugging</span>
<span class="s2">            );</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create indexes for reliability and performance</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE INDEX IF NOT EXISTS idx_jobs_pending_priority </span>
<span class="s2">            ON scheduled_jobs(status, priority ASC, execution_time ASC)</span>
<span class="s2">            WHERE status = &#39;pending&#39;;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE INDEX IF NOT EXISTS idx_jobs_lease_expiration</span>
<span class="s2">            ON scheduled_jobs(status, lease_until, execution_time)</span>
<span class="s2">            WHERE status = &#39;pending&#39;;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE INDEX IF NOT EXISTS idx_jobs_running_heartbeat </span>
<span class="s2">            ON scheduled_jobs(status, last_heartbeat, worker_id)</span>
<span class="s2">            WHERE status = &#39;running&#39;;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE INDEX IF NOT EXISTS idx_jobs_worker_cleanup</span>
<span class="s2">            ON scheduled_jobs(worker_id, status)</span>
<span class="s2">            WHERE worker_id IS NOT NULL;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create vacuum statistics table if metrics tracking is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">track_metrics</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE IF NOT EXISTS vacuum_stats (</span>
<span class="s2">                    stat_date DATE PRIMARY KEY DEFAULT CURRENT_DATE,</span>
<span class="s2">                    deleted_completed INTEGER DEFAULT 0,</span>
<span class="s2">                    deleted_failed INTEGER DEFAULT 0,</span>
<span class="s2">                    deleted_cancelled INTEGER DEFAULT 0,</span>
<span class="s2">                    last_run TIMESTAMPTZ,</span>
<span class="s2">                    worker_id TEXT  -- Track which worker performed the vacuum</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database initialized with reliability features and vacuum metrics&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database initialized with reliability features&quot;</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute database query with retry logic for transient failures&quot;&quot;&quot;</span>
        <span class="n">last_exception</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_pool</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_pool</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Exponential backoff for retries</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># 0.1s, 0.2s, 0.4s</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database operation failed (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">), &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database operation failed permanently after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">raise</span> <span class="n">last_exception</span>

<div class="viewcode-block" id="Scheduler.recover_orphaned_jobs">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.recover_orphaned_jobs">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">recover_orphaned_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recover jobs that were running when workers crashed&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find jobs that were &quot;running&quot; but have stale heartbeats or dead workers</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
            <span class="n">stale_threshold</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">HEARTBEAT_THRESHOLD</span><span class="p">)</span>
            
            <span class="n">recovered_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE scheduled_jobs </span>
<span class="s2">                SET status = &#39;pending&#39;, </span>
<span class="s2">                    worker_id = NULL,</span>
<span class="s2">                    last_heartbeat = NULL,</span>
<span class="s2">                    lease_until = NULL</span>
<span class="s2">                WHERE status = &#39;running&#39; </span>
<span class="s2">                AND (last_heartbeat &lt; $1 OR last_heartbeat IS NULL)</span>
<span class="s2">                RETURNING job_id, job_name, worker_id;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">stale_threshold</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">recovered_jobs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">recovered_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> orphaned jobs from crashed workers&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">recovered_jobs</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovered job </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;from worker </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;worker_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No orphaned jobs found during startup&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to recover orphaned jobs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

            <span class="c1"># Don&#39;t raise - continue with scheduler startup</span>

<div class="viewcode-block" id="Scheduler.periodic_orphan_recovery">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.periodic_orphan_recovery">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">periodic_orphan_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Periodically check for and recover orphaned jobs&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># Check every 5 minutes</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
                    <span class="k">break</span>
                    
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recover_orphaned_jobs</span><span class="p">()</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in periodic orphan recovery: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Back off on errors</span></div>


<div class="viewcode-block" id="Scheduler.schedule">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.schedule">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">func</span><span class="p">,</span> 
        <span class="o">*</span><span class="p">,</span> 
        <span class="n">execution_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">priority</span><span class="p">:</span> <span class="n">JobPriority</span> <span class="o">=</span> <span class="n">JobPriority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">conflict_resolution</span><span class="p">:</span> <span class="n">ConflictResolution</span> <span class="o">=</span> <span class="n">ConflictResolution</span><span class="o">.</span><span class="n">RAISE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule an async I/O function to run at a specific time.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            func: The async function to schedule (must be async I/O only)</span>
<span class="sd">            execution_time: datetime object specifying when to run the job</span>
<span class="sd">            args: Tuple of positional arguments to pass to the function</span>
<span class="sd">            kwargs: Dictionary of keyword arguments to pass to the function</span>
<span class="sd">            priority: Job priority using JobPriority enum (NORMAL or CRITICAL)</span>
<span class="sd">            max_retries: Maximum retry attempts for failed jobs</span>
<span class="sd">            job_id: Optional custom job ID (auto-generated if not provided)</span>
<span class="sd">            conflict_resolution: How to handle duplicate job_id (RAISE, IGNORE, REPLACE)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The job ID of the scheduled job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected an async function, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Store the function in our task map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_map</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        
        <span class="c1"># Package the arguments into task_data</span>
        <span class="n">task_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Schedule the job in the database</span>
        <span class="n">scheduled_job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_job</span><span class="p">(</span>
            <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> 
            <span class="n">execution_time</span><span class="p">,</span> 
            <span class="n">task_data</span><span class="p">,</span> 
            <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">conflict_resolution</span><span class="o">=</span><span class="n">conflict_resolution</span>
        <span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduled async function </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> to run at </span><span class="si">{</span><span class="n">execution_time</span><span class="si">}</span><span class="s2"> (priority=</span><span class="si">{</span><span class="n">priority</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, job_id=</span><span class="si">{</span><span class="n">scheduled_job_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scheduled_job_id</span></div>


<div class="viewcode-block" id="Scheduler.listen_for_jobs">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.listen_for_jobs">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">listen_for_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Listen for jobs with reliability and optimized bulk claiming&quot;&quot;&quot;</span>
        
        <span class="n">startup_jitter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">startup_jitter</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting job listener [worker=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check available semaphore slots</span>
                <span class="n">available_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_semaphore</span><span class="o">.</span><span class="n">_value</span>
                <span class="k">if</span> <span class="n">available_slots</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="n">max_claimable</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">available_slots</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Cap at 5 for reasonable batch size</span>
                
                <span class="c1"># Claim jobs from database</span>
                <span class="n">ready_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_claim_jobs</span><span class="p">(</span><span class="n">max_claimable</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">ready_jobs</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Claimed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ready_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs [worker=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">] (bulk claiming)&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># The semaphore will naturally limit concurrency</span>
                    <span class="k">for</span> <span class="n">job_row</span> <span class="ow">in</span> <span class="n">ready_jobs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_job_with_concurrency_control</span><span class="p">(</span><span class="n">job_row</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                        <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_tasks</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
                
                <span class="c1"># Adaptive sleep</span>
                <span class="c1"># TODO: Maybe find a smarter way to do this ie exponential backoff strategy or something</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">ready_jobs</span><span class="p">:</span>
                    <span class="n">jitter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jitter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in job listener: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_claim_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Claim jobs from database&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use a transaction for atomic job claiming</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_pool</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
                    <span class="c1"># Calculate expiration cutoff for misfire grace time</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
                    <span class="n">expiration_cutoff</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">misfire_grace_time</span><span class="p">)</span>
                    
                    <span class="c1"># Expire old jobs that are past the misfire grace time</span>
                    <span class="n">expired_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        UPDATE scheduled_jobs </span>
<span class="s2">                        SET status = &#39;expired&#39;, worker_id = $1</span>
<span class="s2">                        WHERE status = &#39;pending&#39; </span>
<span class="s2">                        AND execution_time &lt; $2</span>
<span class="s2">                        RETURNING job_id, job_name, execution_time;</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">expiration_cutoff</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">expired_jobs</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expired </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expired_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs past grace time&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Claim ready jobs atomically using CTE pattern (limited by available semaphore slots)</span>
                    <span class="n">ready_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        WITH to_claim AS (</span>
<span class="s2">                            SELECT job_id</span>
<span class="s2">                            FROM scheduled_jobs</span>
<span class="s2">                            WHERE status = &#39;pending&#39;</span>
<span class="s2">                            AND execution_time &lt;= NOW()  -- ready to execute</span>
<span class="s2">                            AND (lease_until IS NULL OR lease_until &lt; NOW())  -- not currently leased</span>
<span class="s2">                            ORDER BY priority ASC, execution_time ASC, job_id ASC</span>
<span class="s2">                            FOR UPDATE SKIP LOCKED</span>
<span class="s2">                            LIMIT $1</span>
<span class="s2">                        )</span>
<span class="s2">                        UPDATE scheduled_jobs j</span>
<span class="s2">                        SET status = &#39;running&#39;,</span>
<span class="s2">                            last_heartbeat = NOW(),</span>
<span class="s2">                            lease_until = NOW() + INTERVAL &#39;60 seconds&#39;,</span>
<span class="s2">                            worker_id = $2</span>
<span class="s2">                        FROM to_claim c</span>
<span class="s2">                        WHERE j.job_id = c.job_id</span>
<span class="s2">                        RETURNING j.job_id, j.job_name, j.execution_time, j.task_data::text,</span>
<span class="s2">                                  j.priority, j.retry_count, j.max_retries;</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
                    
                    <span class="c1"># Track claimed jobs</span>
                    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">ready_jobs</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">])</span>
                    
                    <span class="k">return</span> <span class="n">ready_jobs</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error claiming jobs with slots: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="Scheduler.execute_job_with_concurrency_control">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.execute_job_with_concurrency_control">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute_job_with_concurrency_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute job with semaphore control&quot;&quot;&quot;</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_row</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
        
        <span class="c1"># Ensure semaphore is always released</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_semaphore</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_job</span><span class="p">(</span><span class="n">job_row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Critical error in job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> execution: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Ensure job is properly marked as failed</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_mark_job_failed</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always remove from active jobs tracking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span></div>




<div class="viewcode-block" id="Scheduler.execute_job">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.execute_job">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute job with comprehensive error handling and state management&quot;&quot;&quot;</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_row</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
        <span class="n">job_name</span> <span class="o">=</span> <span class="n">job_row</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="n">JobPriority</span><span class="o">.</span><span class="n">from_db_value</span><span class="p">(</span><span class="n">job_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="c1"># Start heartbeat task</span>
        <span class="n">heartbeat_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_heartbeat</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Validate job data</span>
            <span class="n">task_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">job_row</span><span class="p">[</span><span class="s1">&#39;task_data&#39;</span><span class="p">])</span>
            <span class="n">task_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
            
            <span class="c1"># Handle missing function gracefully</span>
            <span class="k">if</span> <span class="n">task_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No task function found for job </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_mark_job_failed</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">) [priority=</span><span class="si">{</span><span class="n">priority</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">] [worker=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            
            <span class="c1"># Execute the function with timeout protection</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">())</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="p">{})</span>
            
            <span class="c1"># Add timeout to prevent runaway jobs</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">task_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span>  <span class="c1"># 1 hour max per job</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job execution timed out after 1 hour&quot;</span><span class="p">)</span>
            
            <span class="c1"># Atomically mark as completed</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_mark_job_completed</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> completed successfully [worker=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> completed but failed to update status - may be retried&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle job failure with retry logic</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_job_failure</span><span class="p">(</span><span class="n">job_row</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always stop heartbeat task</span>
            <span class="n">heartbeat_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">heartbeat_task</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">pass</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_handle_job_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_row</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle job failure with proper retry logic&quot;&quot;&quot;</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_row</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="n">job_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retry_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="n">job_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_retries&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
            <span class="c1"># Schedule retry with exponential backoff</span>
            <span class="n">retry_delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">retry_count</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>  <span class="c1"># Max 5 minutes</span>
            <span class="n">retry_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">retry_delay</span><span class="p">)</span>
            
            <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_schedule_retry</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">retry_time</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> failed (attempt </span><span class="si">{</span><span class="n">retry_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">), &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;retrying at </span><span class="si">{</span><span class="n">retry_time</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> failed and couldn&#39;t schedule retry: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Exhausted retries - mark as permanently failed</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_mark_job_failed</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> permanently failed after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_safe_mark_job_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely mark job as completed with verification&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE scheduled_jobs </span>
<span class="s2">                SET status = &#39;completed&#39;, </span>
<span class="s2">                    last_heartbeat = NOW(),</span>
<span class="s2">                    error_message = NULL</span>
<span class="s2">                WHERE job_id = $1 AND status = &#39;running&#39; AND worker_id = $2</span>
<span class="s2">                RETURNING job_id;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># True if update succeeded</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to mark job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> as completed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_safe_mark_job_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely mark job as failed&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE scheduled_jobs </span>
<span class="s2">                SET status = &#39;failed&#39;,</span>
<span class="s2">                    error_message = $2,</span>
<span class="s2">                    last_heartbeat = NOW()</span>
<span class="s2">                WHERE job_id = $1 AND worker_id = $3;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">error_message</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>  <span class="c1"># Limit error message length</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to mark job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> as failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_safe_schedule_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">retry_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely schedule job retry&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE scheduled_jobs </span>
<span class="s2">                SET status = &#39;pending&#39;,</span>
<span class="s2">                    retry_count = $2,</span>
<span class="s2">                    execution_time = $3,</span>
<span class="s2">                    error_message = $4,</span>
<span class="s2">                    worker_id = NULL,</span>
<span class="s2">                    last_heartbeat = NULL,</span>
<span class="s2">                    lease_until = NULL</span>
<span class="s2">                WHERE job_id = $1 AND worker_id = $5</span>
<span class="s2">                RETURNING job_id;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">,</span> <span class="n">retry_time</span><span class="p">,</span> <span class="n">error_message</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to schedule retry for job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Scheduler.load_task_functions">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.load_task_functions">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">load_task_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load task functions with error handling&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT DISTINCT job_name FROM scheduled_jobs WHERE status IN (&#39;pending&#39;, &#39;running&#39;);</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">job_name</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_map</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No task function found for job: </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading task functions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Scheduler.monitor_heartbeats">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.monitor_heartbeats">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">monitor_heartbeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Monitor heartbeats and lease expiration with enhanced reliability&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
                <span class="n">heartbeat_threshold</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">HEARTBEAT_THRESHOLD</span><span class="p">)</span>
                
                <span class="c1"># Check for both stale heartbeats AND expired leases</span>
                <span class="n">failed_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE scheduled_jobs </span>
<span class="s2">                    SET status = &#39;pending&#39;,</span>
<span class="s2">                        worker_id = NULL,</span>
<span class="s2">                        last_heartbeat = NULL,</span>
<span class="s2">                        lease_until = NULL</span>
<span class="s2">                    WHERE status = &#39;running&#39; </span>
<span class="s2">                    AND (last_heartbeat &lt; $1 OR lease_until &lt; NOW())</span>
<span class="s2">                    RETURNING job_id, job_name, worker_id, last_heartbeat, lease_until;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">heartbeat_threshold</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">failed_jobs</span><span class="p">:</span>
                    <span class="n">lease_expired</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lease_until&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lease_until&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">current_time</span>
                    <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;lease expired&quot;</span> <span class="k">if</span> <span class="n">lease_expired</span> <span class="k">else</span> <span class="s2">&quot;stale heartbeat&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected stale job </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> from worker </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;worker_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;marking for retry (</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">: heartbeat=</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_heartbeat&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, lease_until=</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;lease_until&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error monitoring heartbeats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span></div>


<div class="viewcode-block" id="Scheduler.send_heartbeat">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.send_heartbeat">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send heartbeats with lease renewal&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE scheduled_jobs </span>
<span class="s2">                    SET last_heartbeat = NOW(),</span>
<span class="s2">                        lease_until = NOW() + INTERVAL &#39;60 seconds&#39;</span>
<span class="s2">                    WHERE job_id = $1 AND status = &#39;running&#39; AND worker_id = $2;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Heartbeat failed for job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_vacuum_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Background vacuum task that periodically cleans up jobs based on policies&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutting_down</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_vacuum_policies</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">interval_minutes</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vacuum task error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Retry after error</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_vacuum_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute vacuum policies&quot;&quot;&quot;</span>
        <span class="c1"># Safety window: Never vacuum jobs that are actively running or recently updated</span>
        <span class="n">safety_window</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">total_deleted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">completed</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">failed</span><span class="p">),</span> 
            <span class="p">(</span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">cancelled</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">NEVER</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_vacuum_policy</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">safety_window</span><span class="p">)</span>
            <span class="n">total_deleted</span> <span class="o">+=</span> <span class="n">deleted_count</span>
            
            <span class="k">if</span> <span class="n">deleted_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vacuum: deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> jobs&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">total_deleted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vacuum completed: deleted </span><span class="si">{</span><span class="n">total_deleted</span><span class="si">}</span><span class="s2"> total jobs&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_apply_vacuum_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">VacuumPolicy</span><span class="p">,</span> <span class="n">safety_window</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a specific vacuum policy and return count of deleted jobs&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">IMMEDIATE</span><span class="p">:</span>
                <span class="c1"># Delete all jobs in this status (respecting safety window)</span>
                <span class="c1"># NULL heartbeat means job is not active, so it&#39;s safe to delete</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    DELETE FROM scheduled_jobs </span>
<span class="s2">                    WHERE status = $1 AND (last_heartbeat IS NULL OR last_heartbeat &lt; $2)</span>
<span class="s2">                    RETURNING job_id;</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">deleted_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">safety_window</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">policy</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">TIME_BASED</span><span class="p">:</span>
                <span class="c1"># Delete jobs older than specified days</span>
                <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    DELETE FROM scheduled_jobs </span>
<span class="s2">                    WHERE status = $1 AND created_at &lt; $2 AND (last_heartbeat IS NULL OR last_heartbeat &lt; $3)</span>
<span class="s2">                    RETURNING job_id;</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">deleted_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">,</span> <span class="n">safety_window</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">policy</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">COUNT_BASED</span><span class="p">:</span>
                <span class="c1"># Keep only the last N jobs per job_name</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    DELETE FROM scheduled_jobs </span>
<span class="s2">                    WHERE job_id IN (</span>
<span class="s2">                        SELECT job_id FROM (</span>
<span class="s2">                            SELECT job_id, </span>
<span class="s2">                                   ROW_NUMBER() OVER (PARTITION BY job_name ORDER BY created_at DESC) as rn</span>
<span class="s2">                            FROM scheduled_jobs </span>
<span class="s2">                            WHERE status = $1 AND (last_heartbeat IS NULL OR last_heartbeat &lt; $2)</span>
<span class="s2">                        ) ranked </span>
<span class="s2">                        WHERE rn &gt; $3</span>
<span class="s2">                    )</span>
<span class="s2">                    RETURNING job_id;</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">deleted_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">safety_window</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">keep_count</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deleted_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">deleted_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">deleted_jobs</span><span class="p">)</span>
            
            <span class="c1"># Record metrics if enabled</span>
            <span class="k">if</span> <span class="n">deleted_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">track_metrics</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_vacuum_metrics</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">deleted_count</span><span class="p">)</span>
                
            <span class="k">return</span> <span class="n">deleted_count</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying vacuum policy for </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> jobs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_record_vacuum_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deleted_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record vacuum metrics in the database&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO vacuum_stats (stat_date, deleted_completed, deleted_failed, deleted_cancelled, last_run, worker_id)</span>
<span class="s2">                VALUES (CURRENT_DATE, </span>
<span class="s2">                        CASE WHEN $1 = &#39;completed&#39; THEN $2 ELSE 0 END,</span>
<span class="s2">                        CASE WHEN $1 = &#39;failed&#39; THEN $2 ELSE 0 END,</span>
<span class="s2">                        CASE WHEN $1 = &#39;cancelled&#39; THEN $2 ELSE 0 END,</span>
<span class="s2">                        NOW(), $3)</span>
<span class="s2">                ON CONFLICT (stat_date) </span>
<span class="s2">                DO UPDATE SET </span>
<span class="s2">                    deleted_completed = vacuum_stats.deleted_completed + EXCLUDED.deleted_completed,</span>
<span class="s2">                    deleted_failed = vacuum_stats.deleted_failed + EXCLUDED.deleted_failed,</span>
<span class="s2">                    deleted_cancelled = vacuum_stats.deleted_cancelled + EXCLUDED.deleted_cancelled,</span>
<span class="s2">                    last_run = EXCLUDED.last_run,</span>
<span class="s2">                    worker_id = EXCLUDED.worker_id;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">deleted_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to record vacuum metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.schedule_job">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.schedule_job">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">schedule_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">,</span> <span class="n">task_data</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="n">JobPriority</span> <span class="o">=</span> <span class="n">JobPriority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">conflict_resolution</span><span class="p">:</span> <span class="n">ConflictResolution</span> <span class="o">=</span> <span class="n">ConflictResolution</span><span class="o">.</span><span class="n">RAISE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a job by inserting it into the &#39;scheduled_jobs&#39; table.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            job_name (str): The name of the job to schedule.</span>
<span class="sd">            execution_time (datetime): The time at which the job should be executed.</span>
<span class="sd">            task_data (dict): Additional data required for the job execution.</span>
<span class="sd">            priority: Job priority using JobPriority enum (NORMAL or CRITICAL)</span>
<span class="sd">            max_retries: Maximum retry attempts for failed jobs</span>
<span class="sd">            job_id: Optional custom job ID (auto-generated if not provided)</span>
<span class="sd">            conflict_resolution: How to handle duplicate job_id (RAISE, IGNORE, REPLACE)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The job ID of the scheduled job</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the provided job_id already exists and conflict_resolution is RAISE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_task_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">task_data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check if job_id already exists first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">existing_job</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT job_id, status FROM scheduled_jobs WHERE job_id = $1;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">existing_job</span><span class="p">:</span>
                    <span class="n">existing_status</span> <span class="o">=</span> <span class="n">existing_job</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">conflict_resolution</span> <span class="o">==</span> <span class="n">ConflictResolution</span><span class="o">.</span><span class="n">RAISE</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Job ID &#39;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&#39; already exists with status &#39;</span><span class="si">{</span><span class="n">existing_status</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Choose a different job_id or omit it for auto-generation.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">conflict_resolution</span> <span class="o">==</span> <span class="n">ConflictResolution</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID &#39;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&#39; already exists, ignoring new job (conflict_resolution=IGNORE)&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">job_id</span>
                    <span class="k">elif</span> <span class="n">conflict_resolution</span> <span class="o">==</span> <span class="n">ConflictResolution</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">:</span>
                        <span class="c1"># Replace/update the existing job</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            UPDATE scheduled_jobs </span>
<span class="s2">                            SET job_name = $2,</span>
<span class="s2">                                execution_time = $3,</span>
<span class="s2">                                task_data = $4::jsonb,</span>
<span class="s2">                                priority = $5,</span>
<span class="s2">                                max_retries = $6,</span>
<span class="s2">                                status = CASE </span>
<span class="s2">                                    WHEN status IN (&#39;completed&#39;, &#39;failed&#39;, &#39;cancelled&#39;, &#39;expired&#39;) THEN &#39;pending&#39;</span>
<span class="s2">                                    ELSE status</span>
<span class="s2">                                END,</span>
<span class="s2">                                retry_count = 0,</span>
<span class="s2">                                error_message = NULL,</span>
<span class="s2">                                worker_id = NULL,</span>
<span class="s2">                                last_heartbeat = NULL,</span>
<span class="s2">                                lease_until = NULL</span>
<span class="s2">                            WHERE job_id = $1</span>
<span class="s2">                            RETURNING job_id;</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">,</span> <span class="n">json_task_data</span><span class="p">,</span> <span class="n">priority</span><span class="o">.</span><span class="n">db_value</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">)</span>
                        
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID &#39;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&#39; replaced with new parameters (conflict_resolution=REPLACE)&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
                
                <span class="c1"># Insert with custom job_id (now we know it&#39;s unique)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    INSERT INTO scheduled_jobs (job_id, job_name, execution_time, status, task_data, priority, max_retries)</span>
<span class="s2">                    VALUES ($1, $2, $3, &#39;pending&#39;, $4::jsonb, $5, $6)</span>
<span class="s2">                    RETURNING job_id;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">,</span> <span class="n">json_task_data</span><span class="p">,</span> <span class="n">priority</span><span class="o">.</span><span class="n">db_value</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># Re-raise our custom error</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle race condition: someone else inserted the same job_id between our check and insert</span>
                <span class="k">if</span> <span class="s2">&quot;duplicate key value violates unique constraint&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">conflict_resolution</span> <span class="o">==</span> <span class="n">ConflictResolution</span><span class="o">.</span><span class="n">RAISE</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Job ID &#39;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&#39; was just created by another process. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Choose a different job_id or omit it for auto-generation.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For IGNORE or REPLACE, try again (recursively call with same parameters)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Race condition detected for job_id &#39;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&#39;, retrying with conflict_resolution=</span><span class="si">{</span><span class="n">conflict_resolution</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">,</span> <span class="n">task_data</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">conflict_resolution</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Re-raise unexpected errors</span>
                    <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Let database auto-generate job_id</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO scheduled_jobs (job_name, execution_time, status, task_data, priority, max_retries)</span>
<span class="s2">                VALUES ($1, $2, &#39;pending&#39;, $3::jsonb, $4, $5)</span>
<span class="s2">                RETURNING job_id;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">,</span> <span class="n">json_task_data</span><span class="p">,</span> <span class="n">priority</span><span class="o">.</span><span class="n">db_value</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">)</span>
        
        <span class="n">scheduled_job_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job scheduled: </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">execution_time</span><span class="si">}</span><span class="s2"> (priority=</span><span class="si">{</span><span class="n">priority</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, job_id=</span><span class="si">{</span><span class="n">scheduled_job_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scheduled_job_id</span></div>


<div class="viewcode-block" id="Scheduler.cancel_job">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.cancel_job">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">cancel_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel a scheduled job by setting its status to &#39;cancelled&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (str): The ID of the job to cancel</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the job was successfully cancelled, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE scheduled_jobs </span>
<span class="s2">                SET status = &#39;cancelled&#39;, </span>
<span class="s2">                    worker_id = NULL,</span>
<span class="s2">                    last_heartbeat = NULL,</span>
<span class="s2">                    lease_until = NULL</span>
<span class="s2">                WHERE job_id = $1 </span>
<span class="s2">                AND status IN (&#39;pending&#39;, &#39;running&#39;)</span>
<span class="s2">                RETURNING job_id, job_name, status;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">cancelled_job</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job cancelled: </span><span class="si">{</span><span class="n">cancelled_job</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (job_id=</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
                <span class="c1"># Remove from active jobs if it was running</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> could not be cancelled (may not exist or already completed)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cancelling job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Scheduler.update_job_status">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.update_job_status">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Atomically update the status of a job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_pool</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE scheduled_jobs</span>
<span class="s2">            SET status = $1</span>
<span class="s2">            WHERE job_id = $2;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span></div>


    <span class="c1"># Vacuum API Methods</span>
    
<div class="viewcode-block" id="Scheduler.run_vacuum">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.run_vacuum">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually trigger vacuum policies and return statistics.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict with counts of deleted jobs by status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_enabled</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Vacuum is disabled - no cleanup performed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
        <span class="c1"># Safety window for manual vacuum</span>
        <span class="n">safety_window</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">completed</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">failed</span><span class="p">),</span> 
            <span class="p">(</span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">cancelled</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">VacuumTrigger</span><span class="o">.</span><span class="n">NEVER</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>
                
            <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_vacuum_policy</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">safety_window</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">=</span> <span class="n">deleted_count</span>
            
            <span class="k">if</span> <span class="n">deleted_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manual vacuum: deleted </span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> jobs&quot;</span><span class="p">)</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manual vacuum completed: deleted </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> total jobs&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="Scheduler.get_vacuum_stats">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.get_vacuum_stats">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_vacuum_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get vacuum statistics for the last N days (requires track_metrics=True).</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            days: Number of days to look back</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of vacuum statistics records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">track_metrics</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Vacuum metrics tracking is disabled - no stats available&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT stat_date, </span>
<span class="s2">                       deleted_completed, </span>
<span class="s2">                       deleted_failed, </span>
<span class="s2">                       deleted_cancelled,</span>
<span class="s2">                       last_run,</span>
<span class="s2">                       worker_id</span>
<span class="s2">                FROM vacuum_stats </span>
<span class="s2">                WHERE stat_date &gt;= CURRENT_DATE - make_interval(days =&gt; $1)</span>
<span class="s2">                ORDER BY stat_date DESC;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching vacuum stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Scheduler.get_total_vacuum_stats">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.get_total_vacuum_stats">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_total_vacuum_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get aggregated vacuum statistics across all time and workers (requires track_metrics=True).</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict with total counts and last vacuum run time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_config</span><span class="o">.</span><span class="n">track_metrics</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Vacuum metrics tracking is disabled - no stats available&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_with_retry</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT SUM(deleted_completed) as total_completed,</span>
<span class="s2">                       SUM(deleted_failed) as total_failed, </span>
<span class="s2">                       SUM(deleted_cancelled) as total_cancelled,</span>
<span class="s2">                       MAX(last_run) as last_vacuum_run</span>
<span class="s2">                FROM vacuum_stats;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching total vacuum stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>


    <span class="c1"># Periodic Job Management Methods</span>
    
<div class="viewcode-block" id="Scheduler.get_periodic_jobs">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.get_periodic_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_periodic_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PeriodicJobConfig</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all registered periodic jobs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="Scheduler.enable_periodic_job">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.enable_periodic_job">[docs]</a>
    <span class="k">def</span> <span class="nf">enable_periodic_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dedup_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable a specific periodic job&quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dedup_key</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">jobs</span><span class="p">[</span><span class="n">dedup_key</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enabled periodic job with dedup_key: </span><span class="si">{</span><span class="n">dedup_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="Scheduler.disable_periodic_job">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.disable_periodic_job">[docs]</a>
    <span class="k">def</span> <span class="nf">disable_periodic_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dedup_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable a specific periodic job&quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dedup_key</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">jobs</span><span class="p">[</span><span class="n">dedup_key</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disabled periodic job with dedup_key: </span><span class="si">{</span><span class="n">dedup_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="Scheduler.trigger_periodic_job">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.trigger_periodic_job">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">trigger_periodic_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dedup_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manually trigger a periodic job execution&quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dedup_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">config</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="n">dedup_key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Execute immediately with a unique job ID</span>
            <span class="n">manual_job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;manual_periodic:</span><span class="si">{</span><span class="n">dedup_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
                <span class="n">execution_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">manual_job_id</span><span class="p">,</span>
                <span class="n">conflict_resolution</span><span class="o">=</span><span class="n">ConflictResolution</span><span class="o">.</span><span class="n">REPLACE</span>
            <span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manually triggered periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">job_id</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to manually trigger periodic job </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="Scheduler.get_periodic_job_status">
<a class="viewcode-back" href="../../api/index.html#pg_scheduler.Scheduler.get_periodic_job_status">[docs]</a>
    <span class="k">def</span> <span class="nf">get_periodic_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dedup_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get status information for a periodic job&quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">_periodic_registry</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dedup_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">config</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="n">dedup_key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">enabled</span><span class="p">,</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">priority</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;max_retries&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="s2">&quot;dedup_key&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">dedup_key</span><span class="p">,</span>
            <span class="s2">&quot;use_advisory_lock&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">use_advisory_lock</span><span class="p">,</span>
            <span class="s2">&quot;function_name&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;function_module&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="p">}</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Miguel Rebelo
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>